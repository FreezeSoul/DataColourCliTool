#!/usr/bin/env node

const fs=require('fs');const path=require('path');const ora=require('ora');const tar=require('tar-fs');const Client=require('ftp');const chalk=require('chalk');const express=require('express');const copydir=require('copy-dir');const program=require('commander');const inquirer=require('inquirer');const symbols=require('log-symbols');const handlebars=require('handlebars');const proxy=require('http-proxy-middleware');const download=require('download-git-repo');const child_process=require('child_process');const githublink='FreezeSoul/DataColourWidgetTemplate#master';try{const packagePath=path['resolve'](__dirname,'package.json');if(fs['existsSync'](packagePath)){const pjson=require(packagePath);const version=pjson['version'];program['version'](version,'-v,\x20--version');}}catch(a0_0xb1bbcd){}program['command']('init\x20<name>')['description']('初始化Widget项目')['action'](_0x3a5ccf=>{if(!fs['existsSync'](_0x3a5ccf)){console['log'](symbols['info'],chalk['white']('初始化Widget项目'));const _0x3e4f35=ora('正在下载Widget模板...');_0x3e4f35['start']();download(githublink,_0x3a5ccf,{'clone':![]},_0x21d553=>{if(_0x21d553){_0x3e4f35['fail']();console['log'](symbols['error'],chalk['red'](_0x21d553));}else{_0x3e4f35['succeed']();process['chdir'](_0x3a5ccf);console['log'](symbols['info'],chalk['white']('开始安装依赖部件...'));child_process['execSync']('npm\x20install',{'stdio':'inherit'});console['log'](symbols['info'],chalk['white']('完成安装依赖部件...'));console['log'](symbols['info'],chalk['white']('初始化一个Widget'));inquirer['prompt']([{'name':'id','message':'请输入Widget的标识，要求英文、数字、下划线'},{'name':'name','message':'请输入Widget的名称，要求简短的中文名称定义'},{'name':'description','message':'请输入Widget的描述，要求简短的中文描述信息'},{'name':'author','message':'请输入作者名称，如：FreezeSoul<freezesoul@gmail.com>'}])['then'](_0x130b64=>{try{const _0x21c5d6=_0x130b64['id'];const _0x577b63=_0x130b64['name'];const _0x3f8093=_0x130b64['description'];const _0x2041d4=_0x130b64['author'];const _0x290cd0=createWidget(_0x21c5d6,_0x577b63,_0x3f8093,_0x2041d4);if(_0x290cd0){console['log'](symbols['success'],chalk['green']('项目初始化完成'));}}catch(_0x290cc6){console['log'](symbols['error'],chalk['red'](_0x290cc6));}});}});}else{console['log'](symbols['error'],chalk['red']('项目'+_0x3a5ccf+'已存在'));}});program['command']('list')['description']('列出所有Widget')['action'](()=>{try{const _0x1011c1='src/widgets/widgets.json';if(fs['existsSync'](_0x1011c1)){const _0x2d1ef6=fs['readFileSync'](_0x1011c1)['toString']();const _0x561f50=JSON['parse'](_0x2d1ef6);for(let _0x350f81 of _0x561f50['widgets']){const _0x3f6e56='src/widgets/'+_0x350f81['path'];const _0x27962b=_0x3f6e56+'/manifest.json';if(fs['existsSync'](_0x27962b)){let _0x1e33bc=fs['readFileSync'](_0x27962b)['toString']();const _0x362860=JSON['parse'](_0x1e33bc);console['log'](symbols['info'],chalk['white']('标识:'+_0x362860['id']+',名称:'+_0x362860['name']+',版本:'+_0x362860['version']));}}}}catch(_0x4ba94d){console['log'](symbols['error'],chalk['red'](_0x4ba94d));}});program['command']('create')['description']('创建一个Widget')['action'](()=>{inquirer['prompt']([{'name':'id','message':'请输入Widget的标识，要求英文、数字、下划线'},{'name':'name','message':'请输入Widget的名称，要求简短的中文名称定义'},{'name':'description','message':'请输入Widget的描述，要求简短的中文描述信息'},{'name':'author','message':'请输入作者名称，如：FreezeSoul<freezesoul@gmail.com>'}])['then'](_0x38ca51=>{try{const _0x49cde7=_0x38ca51['id'];const _0x8cd566=_0x38ca51['name'];const _0x1493f2=_0x38ca51['description'];const _0x1ad726=_0x38ca51['author'];const _0x379e81='src/widgets/'+_0x49cde7;if(!fs['existsSync'](_0x379e81)){const _0x3b8384=createWidget(_0x49cde7,_0x8cd566,_0x1493f2,_0x1ad726);if(_0x3b8384){console['log'](symbols['success'],chalk['green']('Widget创建成功'));}}else{console['log'](symbols['error'],chalk['red']('已经存在Widget:'+_0x49cde7));}}catch(_0x56f11a){console['log'](symbols['error'],chalk['red'](_0x56f11a));}});});program['command']('debug')['description']('调试一个Widget')['action'](()=>{inquirer['prompt']([{'name':'id','message':'请输入要调试的Widget的标识'}])['then'](_0x422af1=>{try{const _0x5a45ee=_0x422af1['id'];const _0x372999='src/widgets/'+_0x5a45ee+'/manifest.json';if(fs['existsSync'](_0x372999)){const _0x10a6a6='src/widgets/widgets.json';let _0x328552=fs['readFileSync'](_0x10a6a6)['toString']();const _0x2a69f4=JSON['parse'](_0x328552);for(let _0x13faa3 of _0x2a69f4['widgets']){_0x13faa3['enable']=_0x13faa3['path']===_0x5a45ee;}_0x328552=JSON['stringify'](_0x2a69f4);fs['writeFileSync'](_0x10a6a6,_0x328552);const _0x5e98a5='http://103.254.70.211:18080';startProxyServer(_0x5e98a5,function(){const _0x21839c=child_process['exec']('npm\x20run\x20start-widget\x20--\x20--name='+_0x5a45ee,{'shell':!![],'detached':!![]});_0x21839c['stdout']['on']('data',function(_0x5a5d85){console['log'](_0x5a5d85['toString']());});_0x21839c['stderr']['on']('data',function(_0x3dc55b){console['log'](_0x3dc55b['toString']());});});}else{console['log'](symbols['error'],chalk['red']('Widget:'+_0x5a45ee+'不存在'));}}catch(_0x27c413){console['log'](symbols['error'],chalk['red'](_0x27c413));}});});program['command']('build')['description']('构建一个Widget')['action'](()=>{inquirer['prompt']([{'name':'id','message':'请输入要构建的Widget的标识'}])['then'](_0x32bf58=>{try{const _0x2d527a=_0x32bf58['id'];const _0x32a571='src/widgets/'+_0x2d527a+'/manifest.json';if(fs['existsSync'](_0x32a571)){child_process['execSync']('npm\x20run\x20build-widget:pro\x20--\x20--name='+_0x2d527a,{'stdio':'inherit'});}else{console['log'](symbols['error'],chalk['red']('Widget:'+_0x2d527a+'不存在'));}}catch(_0x4e88b9){console['log'](symbols['error'],chalk['red'](_0x4e88b9));}});});program['command']('publish')['description']('发布一个Widget')['action'](()=>{inquirer['prompt']([{'name':'id','message':'请输入要发布的Widget的标识'}])['then'](_0x472a54=>{try{const _0x585ee1=_0x472a54['id'];const _0x90822e='src/widgets/'+_0x585ee1;const _0x2ef44d=_0x90822e+'/manifest.json';const _0x43724f=new Date()['toISOString']()['replace'](/T/,'')['replace'](/\..+/,'')['replace'](/-/g,'')['replace'](/:/g,'');const _0x247f67=''+_0x585ee1+_0x43724f;const _0x44ca62=_0x247f67+'.tar';if(fs['existsSync'](_0x2ef44d)){tar['pack'](_0x90822e)['pipe'](fs['createWriteStream'](_0x44ca62));connectFtp(function(_0x124604){const _0x26f630=ora('部件正在发布中...');_0x26f630['start']();const _0x451312=fs['createReadStream'](_0x44ca62);const _0x18915e=fs['statSync'](_0x44ca62)['size'];_0x124604['put'](_0x451312,_0x44ca62,function(_0x4199ad){if(_0x4199ad){_0x26f630['fail']();console['log'](symbols['error'],chalk['red'](_0x4199ad));throw _0x4199ad;}_0x124604['end']();_0x26f630['succeed']('部件正在发布中...');console['log'](symbols['info'],chalk['white']('部件已成功发布...'));console['log'](symbols['info'],chalk['white']('请反馈发布序号:'+_0x247f67));});let _0x33800c=0x0;_0x451312['on']('data',function(_0x5ea929){_0x33800c+=_0x5ea929['length'];_0x26f630['text']='部件正在发布中...\x09'+((_0x33800c/_0x18915e*0x64)['toFixed'](0x2)+'%');});});}else{console['log'](symbols['error'],chalk['red']('Widget:'+_0x585ee1+'不存在'));}}catch(_0x498e96){console['log'](symbols['error'],chalk['red'](_0x498e96));}});});program['parse'](process['argv']);function createWidget(_0x1d3909,_0x384ced,_0x23c448,_0x4a5682){if(!_0x1d3909||!_0x384ced||!_0x23c448){console['log'](symbols['error'],chalk['red']('请提供完整的Widget信息'));return![];}console['log'](symbols['info'],chalk['white']('正在创建Widget:'+_0x1d3909+'...'));try{const _0x139dad='src/widgets/'+_0x1d3909;const _0x4683bc='src/widgets/widget';if(!fs['existsSync'](_0x4683bc)){console['log'](symbols['error'],chalk['red']('Widget模板文件夹不存在'));return![];}if(fs['existsSync'](_0x139dad)){console['log'](symbols['error'],chalk['red']('Widget:'+_0x1d3909+'已存在'));return![];}copydir['sync'](_0x4683bc,_0x139dad);const _0x310b50=_0x139dad+'/manifest.json';let _0x1c0675=fs['readFileSync'](_0x310b50)['toString']();const _0x4ab66d=JSON['parse'](_0x1c0675);_0x4ab66d['id']=_0x1d3909;_0x4ab66d['name']=_0x384ced;_0x4ab66d['description']=_0x23c448;_0x4ab66d['author']=_0x4a5682;_0x1c0675=JSON['stringify'](_0x4ab66d);fs['writeFileSync'](_0x310b50,_0x1c0675);const _0x3aa26b='src/widgets/widgets.json';let _0x4ba604=fs['readFileSync'](_0x3aa26b)['toString']();const _0x34986a=JSON['parse'](_0x4ba604);for(let _0x68d5ce of _0x34986a['widgets']){_0x68d5ce['enable']=![];}_0x34986a['widgets']['push']({'group':'测试','tag':'Test','path':_0x1d3909,'enable':!![]});_0x4ba604=JSON['stringify'](_0x34986a);fs['writeFileSync'](_0x3aa26b,_0x4ba604);console['log'](symbols['info'],chalk['white']('完成创建Widget:'+_0x1d3909+'...'));}catch(_0x1c7977){console['log'](symbols['error'],chalk['red'](_0x1c7977));}return!![];}function startProxyServer(_0x34bd0b,_0x56349e){console['log'](symbols['info'],chalk['blue']('正在启动代理服务...'));var _0x4c42d8=express();_0x4c42d8['use']('/',proxy({'target':_0x34bd0b,'changeOrigin':!![],'pathRewrite':{'/core/widgets':'/widgets'},'router':{'/core/widgets':'http://127.0.0.1:8088/'}}));_0x4c42d8['listen'](0x270f,function(){console['log'](symbols['info'],chalk['blue']('代理服务器已启动...'));if(_0x56349e){_0x56349e();}});}function connectFtp(_0x3bee5a){const _0x37fc48=new Client();const _0x19d17b=ora('开始建立服务器连接...');_0x19d17b['start']();_0x37fc48['on']('ready',function(){_0x19d17b['succeed']();console['log'](symbols['info'],chalk['white']('服务器连接已建立...'));if(_0x3bee5a){_0x3bee5a(_0x37fc48);}});_0x37fc48['on']('error',function(_0x3345ba){_0x19d17b['fail']();console['log'](symbols['error'],chalk['red'](_0x3345ba));});_0x37fc48['connect']({'host':'173.242.120.250','user':'datacolour','password':'datacolour'});}